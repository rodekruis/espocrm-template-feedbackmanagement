{
    "beforeSaveCustomScript": "// Fix logic related to HHH\nif (cTempHeadOfHouseHold != null) {\n    // If HHH was set in cPersonAffected formula, use that\n    cHeadOfHouseHoldId = cTempHeadOfHouseHold;\n    cTempHeadOfHouseHold = null;\n} else {\n    // Else, use own fields\n    memberCount = array\\length(cPersonAffectedIds);\n    if (cHeadOfHouseHoldId != null) {\n        // if HHH not among HH members, add them\n        if (!array\\includes(cPersonAffectedIds, cHeadOfHouseHoldId)) {\n            cPersonAffectedIds = array\\push(cPersonAffectedIds, cHeadOfHouseHoldId);\n        }\n        // if HHH not marked as such, do it\n        if (record\\attribute('CPersonAffected', cHeadOfHouseHoldId, 'isThisMemberAHeadOfHousehold') == false) {\n            record\\update('CPersonAffected', cHeadOfHouseHoldId, 'isThisMemberAHeadOfHouseholdTemp', 'true');\n        }\n    } else {\n        // if no HHH specified, set as oldest of HH members\n        $oldestPersonAffectedId = record\\findRelatedOne('CHousehold', id, 'cPersonAffected', 'age', 'desc', 'cHouseholdId=', id);\n        if ($oldestPersonAffectedId) {\n            cHeadOfHouseHoldId = $oldestPersonAffectedId;\n            record\\update('CPersonAffected', $oldestPersonAffectedId, 'isThisMemberAHeadOfHouseholdTemp', 'true');\n        };\n    };\n    // mark all non-HHH as such\n    $i = 0;\n    while ($i < memberCount) {\n        $PAId = array\\at(cPersonAffectedIds, $i);\n        if ($PAId != cHeadOfHouseHoldId && record\\attribute('CPersonAffected', $PAId, 'isThisMemberAHeadOfHousehold') == true) {\n            record\\update('CPersonAffected', $PAId, 'isThisMemberAHeadOfHouseholdTemp', 'false');\n        }\n        $i = $i + 1;\n    };\n    name = string\\concatenate(\"Household \", record\\attribute('CPersonAffected', cHeadOfHouseHoldId, 'lastName'));\n};\n\n// Count the number of males, females, children, and pregnant women\nif (calculatedTempMale != null || calculatedTempFemale != null || calculatedTempChildren != null || calculatedTempPregnant != null) {\n    // If values were calculated in cPersonAffected formula, use those\n    calculatedMale = calculatedTempMale;\n    calculatedFemale = calculatedTempFemale;\n    calculatedChildren = calculatedTempChildren;\n    calculatedPregnant = calculatedTempPregnant;\n    memberCount =array\\length(cPersonAffectedIds);\n//  memberCount = calculatedMale + calculatedFemale;\n    calculatedTempMale = null;\n    calculatedTempFemale = null;\n    calculatedTempChildren = null;\n    calculatedTempPregnant = null;\n} else {\n    // Else, count from own fields\n    $numberOfMales = 0;\n    $numberOfFemales = 0;\n    $numberOfChildren = 0;\n    $numberOfPregnant = 0;\n    $i = 0;\n    $today = datetime\\now();\n    while ($i < memberCount) {\n        $PAID = array\\at(cPersonAffectedIds, $i);\n        $PAGender = record\\attribute(\"CPersonAffected\", $PAID, \"gender\");\n        $PAPregnant = record\\attribute(\"CPersonAffected\", $PAID, \"isThisMemberAPregnantWoman\");\n        $PABirthday = record\\attribute(\"CPersonAffected\", $PAID, \"dateofbirth\");\n        $age = datetime\\diff($today, $PABirthday, 'years');\n        if ($PAGender == \"Male\") {\n            $numberOfMales = $numberOfMales + 1; \n        } else if ($PAGender == \"Female\") {\n            $numberOfFemales = $numberOfFemales + 1;    \n        };\n        if ($age < 18) {\n            $numberOfChildren = $numberOfChildren + 1;\n        };\n        if ($PAPregnant == true) {\n            $numberOfPregnant = $numberOfPregnant + 1;\n        };\n        $i = $i + 1;\n    };\n    calculatedMale = $numberOfMales;\n    calculatedFemale = $numberOfFemales;\n    calculatedChildren = $numberOfChildren;\n    calculatedPregnant = $numberOfPregnant;\n};"
}