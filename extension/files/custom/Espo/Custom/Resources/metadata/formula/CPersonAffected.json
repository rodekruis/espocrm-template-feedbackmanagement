{
    "beforeSaveCustomScript": "if (extraName != null) {\n    name = string\\concatenate(firstName, string\\concatenate(extraName, \" \", lastName));\n} else {\n    name = string\\concatenate(firstName,\" \", lastName);\n};\n\n$today = datetime\\today();\nage = datetime\\diff($today, dateofbirth,'years');\n\n// Fix logic related to HHH\nif (isThisMemberAHeadOfHouseholdTemp != 'null') {\n    if (isThisMemberAHeadOfHouseholdTemp == 'true') {\n        isThisMemberAHeadOfHousehold = true\n    } else {\n        isThisMemberAHeadOfHousehold = false\n    }\n    isThisMemberAHeadOfHouseholdTemp = 'null';\n};\n\nif (cHouseholdId) {\n    if (isThisMemberAHeadOfHousehold == true) {\n        // Update field HHH in HH\n        record\\update('CHousehold', cHouseholdId, 'cTempHeadOfHouseHold', id, 'name', string\\concatenate(\"Household \", lastName));\n        // mark all non-HHH as such\n        $ids = record\\findMany('CPersonAffected', 10, 'createdAt', 'desc', 'cHouseholdId=', cHouseholdId);\n        $memberCount = array\\length($ids);\n        $i = 0;\n        while ($i < $memberCount) {\n            $PAId = array\\at($ids, $i);\n            if ($PAId != id) {\n                record\\update('CPersonAffected', $PAId, 'isThisMemberAHeadOfHousehold', false);\n            }\n            $i = $i + 1;\n        }\n    } else if (record\\attribute('CHousehold', cHouseholdId, 'cHeadOfHouseHoldId') == id) {\n        // if this PA was HHH, set the oldest of HH members as HHH\n        $oldestPersonAffectedId = record\\findRelatedOne('CHousehold', cHouseholdId, 'cPersonAffected', 'age', 'desc', 'cHouseholdId=', cHouseholdId);\n        if ($oldestPersonAffectedId == id) {\n            // if this PA is the oldest HH member, then keep it as HHH\n            isThisMemberAHeadOfHousehold = true;\n        } else {\n            // set the oldest of HH members as HHH\n            record\\update('CHousehold', cHouseholdId, 'cTempHeadOfHouseHold', $oldestPersonAffectedId, 'name', string\\concatenate(\"Household \", record\\attribute('CPersonAffected', $oldestPersonAffectedId, 'lastName')));\n            record\\update('CPersonAffected', $oldestPersonAffectedId, 'isThisMemberAHeadOfHousehold', true);\n        };\n    } else if (record\\attribute('CHousehold', cHouseholdId, 'cHeadOfHouseHoldId') == null) {\n        // if HH has no HHH, set this PA as HHH and update calculated fields\n        isThisMemberAHeadOfHousehold = true;\n        $numberOfMales = 0;\n        $numberOfFemales = 0;\n        $numberOfChildren = 0;\n        $numberOfPregnant = 0;\n        $today = datetime\\now();\n        $age = datetime\\diff($today, dateofbirth, 'years');\n        if (gender == \"Male\") {\n            $numberOfMales = 1; \n        } else if (gender == \"Female\") {\n            $numberOfFemales = 1;    \n        };\n        if ($age < 18) {\n            $numberOfChildren = 1;\n        };\n        if (isThisMemberAPregnantWoman == true) {\n            $numberOfPregnant = 1;\n        };\n        record\\update('CHousehold', cHouseholdId, 'cTempHeadOfHouseHold', id, 'calculatedTempMale', $numberOfMales, 'calculatedTempFemale', $numberOfFemales, 'calculatedTempChildren', $numberOfChildren, 'calculatedTempPregnant', $numberOfPregnant, 'name', string\\concatenate(\"Household \", lastName));\n    };\n    \n    $personAffectedIds = record\\attribute(\"CHousehold\", cHouseholdId, \"cPersonAffectedIds\");\n    if (array\\includes($personAffectedIds, id)) {\n        // Update fields in HH: males, females, children, and pregnant women\n        $memberCount = array\\length($personAffectedIds);\n        $numberOfMales = 0;\n        $numberOfFemales = 0;\n        $numberOfChildren = 0;\n        $numberOfPregnant = 0;\n        $i = 0;\n        $today = datetime\\now();\n        while ($i < $memberCount) {\n            $PAID = array\\at($personAffectedIds, $i);\n            if ($PAID != id) {\n                $PAGender = record\\attribute(\"CPersonAffected\", $PAID, \"gender\");\n                $PAPregnant = record\\attribute(\"CPersonAffected\", $PAID, \"isThisMemberAPregnantWoman\");\n                $PABirthday = record\\attribute(\"CPersonAffected\", $PAID, \"dateofbirth\");\n                $age = datetime\\diff($today, $PABirthday, 'years');\n            } else {\n                $PAGender = gender;\n                $PAPregnant = isThisMemberAPregnantWoman;\n                $PABirthday = dateofbirth;\n                $age = datetime\\diff($today, $PABirthday, 'years');       \n            };\n            if ($PAGender == \"Male\") {\n                $numberOfMales = $numberOfMales + 1; \n            } else if ($PAGender == \"Female\") {\n                $numberOfFemales = $numberOfFemales + 1;    \n            };\n            if ($age < 18) {\n                $numberOfChildren = $numberOfChildren + 1;\n            };\n            if ($PAPregnant == true) {\n                $numberOfPregnant = $numberOfPregnant + 1;\n            };\n            $i = $i + 1;\n        };\n        if ($numberOfMales != record\\attribute('CHousehold', cHouseholdId, 'calculatedMale') || \n        $numberOfFemales != record\\attribute('CHousehold', cHouseholdId, 'calculatedFemale') || \n        $numberOfChildren != record\\attribute('CHousehold', cHouseholdId, 'calculatedChildren') || \n        $numberOfPregnant != record\\attribute('CHousehold', cHouseholdId, 'calculatedPregnant')) {\n            record\\update('CHousehold', cHouseholdId, 'calculatedTempMale', $numberOfMales, 'calculatedTempFemale', $numberOfFemales, 'calculatedTempChildren', $numberOfChildren, 'calculatedTempPregnant', $numberOfPregnant);\n        };\n    } else {\n        // if PA not already among HH members, then is being added\n        $numberOfMales = record\\attribute('CHousehold', cHouseholdId, 'calculatedMale');\n        $numberOfFemales = record\\attribute('CHousehold', cHouseholdId, 'calculatedFemale');\n        $numberOfChildren = record\\attribute('CHousehold', cHouseholdId, 'calculatedChildren');\n        $numberOfPregnant = record\\attribute('CHousehold', cHouseholdId, 'calculatedPregnant');\n        $today = datetime\\now();\n        $age = datetime\\diff($today, dateofbirth, 'years');\n        if (gender == \"Male\") {\n            $numberOfMales = $numberOfMales + 1; \n        } else if (gender == \"Female\") {\n            $numberOfFemales = $numberOfFemales + 1;    \n        };\n        if ($age < 18) {\n            $numberOfChildren = $numberOfChildren + 1;\n        };\n        if (isThisMemberAPregnantWoman == true) {\n            $numberOfPregnant = $numberOfPregnant + 1;\n        };\n        record\\update('CHousehold', cHouseholdId, 'calculatedTempMale', $numberOfMales, 'calculatedTempFemale', $numberOfFemales, 'calculatedTempChildren', $numberOfChildren, 'calculatedTempPregnant', $numberOfPregnant);\n    };\n} else {\n    isThisMemberAHeadOfHousehold == false; \n};\n\n"
}